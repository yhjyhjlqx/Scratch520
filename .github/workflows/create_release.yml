name: Create Scratch520 Release

on:
  push:
    tags: ['v*']  # ä»…å½“æ¨é€vå¼€å¤´çš„tagæ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-release:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ç¬¬ä¸€æ­¥ï¼šå¿…é¡»å…ˆæ£€å‡ºä»£ç ï¼ˆå…³é”®ä¿®å¤ç‚¹ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´gitå†å²è®°å½•
          ref: ${{ github.ref_name || 'main' }}

      # ç¬¬äºŒæ­¥ï¼šæ‰‹åŠ¨è§¦å‘æ—¶åˆ›å»ºä¸´æ—¶tag
      - name: Create temporary tag (if manual trigger)
        if: github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/')
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          TAG_NAME="v0.0.0-manual-${{ github.run_id }}"
          git tag -a "$TAG_NAME" -m "Temporary tag for manual workflow dispatch"
          git push origin "$TAG_NAME"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "Created temporary tag: $TAG_NAME"

      # ç¬¬ä¸‰æ­¥ï¼šéªŒè¯ç¯å¢ƒ
      - name: Verify environment
        run: |
          echo "Current branch: ${{ github.ref }}"
          echo "Current tag: ${{ github.ref_name }}"
          git status
          ls -la

      # ç¬¬å››æ­¥ï¼šå‡†å¤‡å‘å¸ƒåŒ…ï¼ˆå¢å¼ºå®¹é”™ï¼‰
      - name: Prepare release assets
        run: |
          # åˆ›å»ºç›®å½•ç»“æ„
          mkdir -p release_package/scripts
          
          # å¤åˆ¶æ–‡ä»¶ï¼ˆå¸¦é”™è¯¯å¿½ç•¥ï¼‰
          cp -f hosts release_package/ || echo "âš ï¸ hosts file missing"
          [ -f scripts/windows_update.ps1 ] && cp scripts/windows_update.ps1 release_package/scripts/
          [ -f scripts/macos_update.sh ] && cp scripts/macos_update.sh release_package/scripts/
          [ -f scripts/linux_update.sh ] && cp scripts/linux_update.sh release_package/scripts/

          # æ‰“åŒ…å¹¶éªŒè¯
          zip -r Scratch520_Scripts.zip release_package/
          unzip -l Scratch520_Scripts.zip
          echo "::notice:: Package prepared successfully"

      # ç¬¬äº”æ­¥ï¼šåˆ›å»ºGitHub Release
      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Scratch520_Scripts.zip
          tag_name: ${{ github.ref_name || env.TAG_NAME || 'v0.0.0-fallback' }}
          name: Scratch520 ${{ github.ref_name || env.TAG_NAME || 'Manual Release' }}
          body: |
            ### ğŸš€ è‡ªåŠ¨ç”Ÿæˆçš„å‘å¸ƒåŒ…

            **åŒ…å«æ–‡ä»¶ï¼š**
            - Windowsè„šæœ¬: `windows_update.ps1`
            - macOSè„šæœ¬: `macos_update.sh`
            - Linuxè„šæœ¬: `linux_update.sh`
            - æœ€æ–°Hostsæ–‡ä»¶: `hosts`

            **ä½¿ç”¨æ–¹å¼ï¼š**
            1. ä¸‹è½½ZIPåŒ…å¹¶è§£å‹
            2. è¿è¡Œå¯¹åº”å¹³å°çš„è„šæœ¬
            3. æ›´å¤šå¸®åŠ©è§[README](https://github.com/${{ github.repository }}#ä½¿ç”¨æ–¹æ³•)

            **ç”Ÿæˆæ—¶é—´ï¼š** ${{ steps.prepare.outputs.current_date }}
          draft: false
          prerelease: ${{ !github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ç¬¬å…­æ­¥ï¼šæ¸…ç†å’Œé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Cleanup
        if: always()
        run: |
          echo "::group::å·¥ä½œç›®å½•å†…å®¹"
          ls -R
          echo "::endgroup::"
          echo "ğŸ‰ å·¥ä½œæµå·²å®Œæˆï¼"
